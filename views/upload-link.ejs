<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#8a2be2">
  <title>Upload Anime - AnimeStream</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    .info-box {
      background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(192, 132, 252, 0.1));
      border-left: 4px solid #a855f7;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
    }
    
    .info-box h4 {
      color: #a855f7;
      margin-bottom: 0.5rem;
    }
    
    .info-box p {
      color: #666;
      font-size: 0.9rem;
      line-height: 1.6;
    }
    
    .info-box ul {
      margin-top: 0.5rem;
      padding-left: 1.5rem;
      color: #666;
      font-size: 0.9rem;
    }
  </style>
</head>
<body class="upload-page">
  <!-- Navbar -->
  <nav class="navbar">
    <div class="container">
      <div class="nav-left">
        <a href="/" class="logo">üé¨ AnimeStream</a>
        <div class="nav-menu">
          <a href="/" class="nav-link">Beranda</a>
          <a href="/upload" class="nav-link active">Upload</a>
          <% if (user) { %>
            <a href="/dashboard" class="nav-link">Dashboard</a>
          <% } %>
        </div>
      </div>

      <div class="nav-right">
        <% if (user) { %>
          <div class="user-menu">
            <div class="user-avatar"><%= user.username.charAt(0).toUpperCase() %></div>
            <span class="user-name"><%= user.username %></span>
          </div>
          <a href="/logout" class="btn-logout" style="margin-left: 1rem; padding: 0.5rem 1rem; background: #ff4757; color: white; border-radius: 8px; text-decoration: none; font-size: 0.9rem;">Keluar</a>
        <% } else { %>
          <a href="/login" class="btn-login">Masuk</a>
        <% } %>
      </div>
    </div>
  </nav>

  <!-- Upload Container -->
  <div class="container">
    <div class="upload-container">
      <!-- Header -->
      <div class="upload-header">
        <h2>üì§ Upload Video Anime</h2>
        <p>Upload video langsung dari galeri HP atau file PC kamu</p>
      </div>

      <div class="upload-body">
        <!-- Info Box -->
        <div class="info-box">
          <h4>üìÅ Upload File Video</h4>
          <p>Pilih video dari galeri HP atau file PC kamu, lalu isi informasi anime.</p>
          <p><strong>üìå Catatan:</strong></p>
          <ul style="margin-top: 0.5rem; padding-left: 1.5rem; color: #666; font-size: 0.9rem;">
            <li><strong>Max 500MB</strong> - File lebih besar akan gagal</li>
            <li><strong>Progress bar</strong> akan tampil saat upload (MB naik 0-100%)</li>
            <li><strong>Koneksi stabil</strong> diperlukan untuk file besar</li>
            <li><strong>Format:</strong> MP4, MKV, AVI, WebM, MOV</li>
          </ul>
        </div>

        <!-- File Upload Form -->
        <form action="/upload" method="POST" enctype="multipart/form-data" id="fileUploadForm">
          <!-- File Input -->
          <div class="form-group">
            <label>üé• Pilih Video</label>
            <div class="file-input-area" style="background: rgba(168, 85, 247, 0.05); border: 2px dashed #a855f7; border-radius: 12px; padding: 2rem; text-align: center;">
              <div class="icon" style="font-size: 3rem; margin-bottom: 1rem;">üì±</div>
              <h3 style="margin-bottom: 0.5rem;">Pilih Video dari Galeri/PC</h3>
              <p style="color: #999; margin-top: 0.5rem;">Klik tombol di bawah untuk pilih video</p>
              <p id="fileName" style="color: #a855f7; margin-top: 1rem; font-weight: 600; min-height: 24px;"></p>
              
              <!-- File input visible untuk mobile -->
              <input type="file" id="videoFile" name="video" accept="video/*,video/mp4,video/x-matroska,video/avi,video/webm,video/quicktime" required 
                     style="display: block; margin: 1rem auto; padding: 0.8rem; background: linear-gradient(135deg, #a855f7, #c084fc); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; max-width: 300px;">
            </div>
          </div>

          <!-- Progress Bar -->
          <div id="uploadProgress" style="display: none; margin-bottom: 1.5rem; background: rgba(168, 85, 247, 0.05); padding: 1.5rem; border-radius: 12px; border: 2px solid #a855f7;">
            <h4 id="progressTitle" style="color: #a855f7; margin-bottom: 1rem; text-align: center; font-size: 1.2rem;">
              <span id="progressIcon" style="font-size: 1.5rem;">‚è≥</span>
              <span id="progressTitleText">Memulai Upload...</span>
            </h4>
            <div style="background: rgba(168, 85, 247, 0.2); border-radius: 8px; overflow: hidden; height: 40px; margin-bottom: 1rem;">
              <div id="progressBar" style="background: linear-gradient(135deg, #a855f7, #c084fc); height: 100%; width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.1rem; box-shadow: 0 2px 8px rgba(168, 85, 247, 0.4);">0%</div>
            </div>
            <p id="progressText" style="text-align: center; margin: 0; color: #666; font-size: 1rem; font-weight: 600;">Memulai upload...</p>
          </div>

          <!-- Anime Info -->
          <div class="form-group">
            <label for="fileTitle">üé¨ Judul Anime</label>
            <input type="text" id="fileTitle" name="title" required placeholder="Contoh: Naruto Shippuden">
          </div>

          <div class="form-group">
            <label for="fileEpisode">üì∫ Episode</label>
            <input type="text" id="fileEpisode" name="episode" required placeholder="Contoh: Episode 1">
          </div>

          <div class="form-group">
            <label for="fileCategory">üìÇ Kategori</label>
            <select id="fileCategory" name="category">
              <option value="action">Action</option>
              <option value="adventure">Adventure</option>
              <option value="comedy">Comedy</option>
              <option value="drama">Drama</option>
              <option value="fantasy">Fantasy</option>
              <option value="romance">Romance</option>
              <option value="sci-fi">Sci-Fi</option>
              <option value="slice-of-life">Slice of Life</option>
            </select>
          </div>

          <div class="form-group">
            <label for="fileGenre">üè∑Ô∏è Genre (pisahkan dengan koma)</label>
            <input type="text" id="fileGenre" name="genre" placeholder="Contoh: Action, Adventure, Shounen">
          </div>

          <div class="form-group">
            <label for="fileDescription">üìù Deskripsi</label>
            <textarea id="fileDescription" name="description" rows="5" required placeholder="Ceritakan tentang anime ini..."></textarea>
          </div>

          <!-- Submit Button -->
          <button type="submit" class="btn btn-primary" id="uploadBtn" style="width: 100%; padding: 1rem; font-size: 1.1rem; font-weight: 600;">
            üöÄ Upload Video
          </button>
        </form>
      </div>
    </div>
  </div>

  <script>
    // Update file name display
    const videoFileInput = document.getElementById('videoFile');
    const fileNameDisplay = document.getElementById('fileName');
    
    videoFileInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const fileName = file.name;
        const fileSize = (file.size / (1024 * 1024)).toFixed(2);
        fileNameDisplay.textContent = `üìÅ ${fileName} (${fileSize} MB)`;
        fileNameDisplay.style.color = '#a855f7';
        console.log('File selected:', fileName, fileSize + 'MB');
      } else {
        fileNameDisplay.textContent = '';
      }
    });
    
    // File upload with progress
    document.getElementById('fileUploadForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const fileInput = document.getElementById('videoFile');
      const file = fileInput.files[0];
      
      console.log('üì§ Starting file upload...', {
        fileName: file?.name,
        fileSize: file?.size,
        fileType: file?.type
      });
      
      if (!file) {
        alert('‚ùå Pilih video terlebih dahulu!');
        return;
      }
      
      // Check file size (max 500MB)
      const maxSize = 500 * 1024 * 1024;
      if (file.size > maxSize) {
        alert('‚ùå File terlalu besar! Maksimal 500MB\n\nüí° Solusi: Pakai "Upload dengan Link" untuk file unlimited!');
        return;
      }
      
      // Validate form fields
      const title = document.getElementById('fileTitle').value;
      const episode = document.getElementById('fileEpisode').value;
      const description = document.getElementById('fileDescription').value;
      
      if (!title || !episode || !description) {
        alert('‚ùå Semua field harus diisi!\n\nPastikan:\n- Judul Anime\n- Episode\n- Deskripsi\n\nSudah terisi semua.');
        return;
      }
      
      console.log('‚úÖ Validation passed, starting upload...');
      
      // Show progress dengan animasi
      const progressContainer = document.getElementById('uploadProgress');
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      const progressIcon = document.getElementById('progressIcon');
      const progressTitleText = document.getElementById('progressTitleText');
      const uploadBtn = document.getElementById('uploadBtn');
      
      progressContainer.style.display = 'block';
      progressBar.style.width = '0%';
      progressBar.textContent = '0%';
      progressText.textContent = 'Memulai upload...';
      progressIcon.textContent = '‚è≥';
      progressTitleText.textContent = 'Memulai Upload...';
      uploadBtn.disabled = true;
      uploadBtn.textContent = '‚è≥ Uploading...';
      uploadBtn.style.opacity = '0.6';
      
      console.log('üìä Progress bar displayed');
      
      // Create FormData
      const formData = new FormData(this);
      
      console.log('üì¶ FormData created, sending to server...');
      
      // Upload with XMLHttpRequest for progress tracking
      const xhr = new XMLHttpRequest();
      
      xhr.upload.addEventListener('progress', function(e) {
        if (e.lengthComputable) {
          const percentComplete = Math.round((e.loaded / e.total) * 100);
          const loadedMB = (e.loaded / (1024 * 1024)).toFixed(2);
          const totalMB = (e.total / (1024 * 1024)).toFixed(2);
          
          console.log(`üìä Upload progress: ${percentComplete}% (${loadedMB}MB / ${totalMB}MB)`);
          
          // Update progress bar
          progressBar.style.width = percentComplete + '%';
          progressBar.textContent = percentComplete + '%';
          progressText.textContent = `Uploading... ${loadedMB} MB / ${totalMB} MB (${percentComplete}%)`;
          
          // Update icon based on progress
          if (percentComplete === 0) {
            progressIcon.textContent = '‚è≥';
            progressTitleText.textContent = 'Memulai Upload...';
          } else if (percentComplete < 25) {
            progressIcon.textContent = 'üì§';
            progressTitleText.textContent = 'Uploading... ' + percentComplete + '%';
          } else if (percentComplete < 50) {
            progressIcon.textContent = 'üìä';
            progressTitleText.textContent = 'Uploading... ' + percentComplete + '%';
          } else if (percentComplete < 75) {
            progressIcon.textContent = 'üöÄ';
            progressTitleText.textContent = 'Uploading... ' + percentComplete + '%';
          } else if (percentComplete < 100) {
            progressIcon.textContent = '‚ö°';
            progressTitleText.textContent = 'Hampir Selesai... ' + percentComplete + '%';
          } else {
            progressIcon.textContent = '‚úÖ';
            progressTitleText.textContent = 'Upload Selesai!';
            progressBar.style.background = 'linear-gradient(135deg, #4caf50, #8bc34a)';
            progressText.textContent = '‚úÖ Upload selesai! Memproses...';
          }
        } else {
          console.log('üìä Upload progress: unknown (no content length)');
          progressIcon.textContent = 'üì§';
          progressTitleText.textContent = 'Uploading...';
          progressText.textContent = 'Uploading... (progress tidak tersedia)';
        }
      });
      
      xhr.addEventListener('load', function() {
        console.log('üì• Server response received:', {
          status: xhr.status,
          statusText: xhr.statusText,
          responseLength: xhr.responseText?.length
        });
        
        if (xhr.status === 200) {
          try {
            const response = JSON.parse(xhr.responseText);
            console.log('‚úÖ Response parsed:', response);
            
            if (response.success) {
              alert('‚úÖ Upload berhasil!');
              window.location.href = '/';
            } else {
              console.error('‚ùå Upload failed:', response.error);
              alert('‚ùå Upload gagal: ' + (response.error || 'Unknown error'));
              resetUploadForm();
            }
          } catch (e) {
            console.error('‚ùå Parse error:', e, 'Response:', xhr.responseText);
            alert('‚ùå Server error! Response tidak valid.');
            resetUploadForm();
          }
        } else if (xhr.status === 413) {
          console.error('‚ùå File too large (413)');
          alert('‚ùå File terlalu besar! Server tidak bisa menerima file ini.\n\nSolusi:\n1. Kompres video dulu\n2. Atau pakai "Upload dengan Link" (unlimited size)');
          resetUploadForm();
        } else if (xhr.status === 0) {
          console.error('‚ùå Request failed (status 0) - timeout or cancelled');
          alert('‚ùå Upload dibatalkan atau timeout!\n\nKemungkinan:\n1. File terlalu besar untuk koneksi kamu\n2. Server tidak merespon\n3. Koneksi terputus\n\nSolusi: Pakai "Upload dengan Link" untuk file besar!');
          resetUploadForm();
        } else {
          console.error('‚ùå HTTP error:', xhr.status, xhr.statusText);
          alert('‚ùå Upload gagal! Status: ' + xhr.status + '\n\nCoba lagi atau pakai "Upload dengan Link"');
          resetUploadForm();
        }
      });
      
      xhr.addEventListener('error', function(e) {
        console.error('XHR Error:', e);
        
        // Check if running on Railway (no R2 configured)
        const isRailway = window.location.hostname.includes('railway.app') || window.location.hostname.includes('up.railway.app');
        
        if (isRailway) {
          alert('‚ùå Upload file tidak work di Railway!\n\n' +
                'Railway pakai ephemeral storage - file akan hilang saat restart.\n\n' +
                '‚úÖ SOLUSI:\n' +
                '1. Setup Cloudflare R2 (persistent storage)\n' +
                '2. Atau pakai "Upload dengan Link" (instant, unlimited!)\n\n' +
                'üí° Recommended: Pakai "Upload dengan Link" - Cloudinary/Streamable gratis & tanpa iklan!');
        } else {
          alert('‚ùå Upload error!\n\n' +
                'Kemungkinan penyebab:\n' +
                '1. Koneksi internet terputus\n' +
                '2. Server tidak merespon\n' +
                '3. File terlalu besar untuk koneksi kamu\n' +
                '4. CORS atau firewall issue\n\n' +
                'üí° Solusi: Pakai "Upload dengan Link" (tab sebelah) untuk hasil terbaik!');
        }
        
        resetUploadForm();
      });
      
      xhr.addEventListener('timeout', function() {
        alert('‚ùå Upload timeout!\n\nFile terlalu besar atau koneksi lambat.\n\nüí° Solusi: Pakai "Upload dengan Link" untuk file besar!');
        resetUploadForm();
      });
      
      xhr.addEventListener('abort', function() {
        alert('‚ö†Ô∏è Upload dibatalkan!');
        resetUploadForm();
      });
      
      // Set timeout 10 minutes
      xhr.timeout = 600000;
      
      xhr.open('POST', '/upload');
      xhr.send(formData);
    });
    
    // Helper function to reset upload form
    function resetUploadForm() {
      document.getElementById('uploadBtn').disabled = false;
      document.getElementById('uploadBtn').textContent = 'üöÄ Upload Video';
      document.getElementById('uploadProgress').style.display = 'none';
      document.getElementById('progressBar').style.width = '0%';
      document.getElementById('progressBar').textContent = '';
      document.getElementById('progressText').textContent = '';
    });
  </script>

  <!-- WhatsApp Floating Button (Fixed for Mobile) -->
  <!-- WhatsApp Floating Button (Top Left) -->
  <a href="https://wa.me/6282297706541?text=Hai" target="_blank" class="wa-float" style="position: fixed; top: 80px; left: 20px; z-index: 99999; width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, #25D366, #128C7E); color: white; display: flex; align-items: center; justify-content: center; font-size: 26px; text-decoration: none; box-shadow: 0 4px 16px rgba(37, 211, 102, 0.6); transition: all 0.3s; will-change: transform; pointer-events: auto;">
    üí¨
  </a>

  <style>
    .wa-float {
      pointer-events: auto !important;
    }
    .wa-float:hover {
      transform: scale(1.1) !important;
      box-shadow: 0 6px 20px rgba(37, 211, 102, 0.8) !important;
    }
    .wa-float:active {
      transform: scale(0.95) !important;
    }
    @media (max-width: 768px) {
      .wa-float {
        top: 70px !important;
        left: 15px !important;
        width: 50px !important;
        height: 50px !important;
        font-size: 22px !important;
      }
    }
  </style>

  <style>
    /* Mobile Performance Optimization */
    * {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
    }
    
    body {
      -webkit-overflow-scrolling: touch;
      overflow-x: hidden;
    }
    
    /* Smooth scroll */
    html {
      scroll-behavior: smooth;
    }
    
    /* WhatsApp button always on top */
    .wa-float {
      pointer-events: auto !important;
    }
    
    .wa-float:hover {
      transform: scale(1.1) !important;
      box-shadow: 0 6px 20px rgba(37, 211, 102, 0.8) !important;
    }
    
    .wa-float:active {
      transform: scale(0.95) !important;
    }
    
    /* Mobile responsive */
    @media (max-width: 768px) {
      .wa-float {
        bottom: 15px !important;
        right: 15px !important;
        width: 50px !important;
        height: 50px !important;
        font-size: 22px !important;
      }
      
      /* Optimize mobile performance */
      .upload-container {
        padding: 1rem;
      }
      
      .upload-method-selector {
        flex-direction: column;
        gap: 0.5rem;
      }
      
      .method-btn {
        padding: 0.75rem;
        font-size: 0.9rem;
      }
      
      .supported-platforms {
        gap: 0.5rem;
      }
      
      .platform-badge {
        padding: 0.4rem 0.8rem;
        font-size: 0.75rem;
      }
      
      /* Reduce animations on mobile for better performance */
      * {
        transition-duration: 0.2s !important;
      }
      
      /* Optimize images and media */
      img, video {
        max-width: 100%;
        height: auto;
      }
    }
    
    /* Prevent layout shift */
    .container {
      contain: layout style paint;
    }
    
    /* GPU acceleration for smooth scroll */
    .navbar, .wa-float {
      transform: translateZ(0);
      backface-visibility: hidden;
      perspective: 1000px;
    }
  </style>
</body>
</html>
