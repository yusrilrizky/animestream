<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload - AnimeStream APK</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <nav class="navbar">
    <div class="container">
      <div class="nav-left">
        <a href="/" class="logo">üé¨ AnimeStream</a>
      </div>
      <div class="nav-right">
        <% if (user) { %>
          <span><%= user.username %></span>
          <a href="/logout">Keluar</a>
        <% } %>
      </div>
    </div>
  </nav>

  <div class="container" style="padding: 2rem;">
    <h2>üì§ Upload Video (APK Mode)</h2>
    
    <div style="background: rgba(168, 85, 247, 0.1); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
      <h3 style="color: #a855f7; margin-bottom: 1rem;">üì± Upload dari Galeri</h3>
      <p style="margin-bottom: 1rem;">Klik tombol di bawah untuk pilih video dari galeri HP kamu.</p>
      
      <button onclick="pickFile()" style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #a855f7, #c084fc); color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer;">
        üìÇ Pilih Video dari Galeri
      </button>
      
      <div id="fileInfo" style="margin-top: 1rem; padding: 1rem; background: white; border-radius: 8px; display: none;">
        <p id="fileName" style="font-weight: 600; color: #a855f7;"></p>
        <p id="fileSize" style="color: #666; font-size: 0.9rem;"></p>
      </div>
    </div>

    <form id="uploadForm" style="display: none;">
      <div style="margin-bottom: 1rem;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">üé¨ Judul Anime</label>
        <input type="text" id="title" required placeholder="Contoh: Naruto Shippuden" style="width: 100%; padding: 0.8rem; border: 2px solid #a855f7; border-radius: 8px;">
      </div>

      <div style="margin-bottom: 1rem;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">üì∫ Episode</label>
        <input type="text" id="episode" required placeholder="Contoh: Episode 1" style="width: 100%; padding: 0.8rem; border: 2px solid #a855f7; border-radius: 8px;">
      </div>

      <div style="margin-bottom: 1rem;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">üìÇ Kategori</label>
        <select id="category" style="width: 100%; padding: 0.8rem; border: 2px solid #a855f7; border-radius: 8px;">
          <option value="action">Action</option>
          <option value="adventure">Adventure</option>
          <option value="comedy">Comedy</option>
          <option value="drama">Drama</option>
          <option value="fantasy">Fantasy</option>
          <option value="romance">Romance</option>
          <option value="sci-fi">Sci-Fi</option>
        </select>
      </div>

      <div style="margin-bottom: 1rem;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">üè∑Ô∏è Genre</label>
        <input type="text" id="genre" placeholder="Contoh: Action, Adventure" style="width: 100%; padding: 0.8rem; border: 2px solid #a855f7; border-radius: 8px;">
      </div>

      <div style="margin-bottom: 1rem;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">üìù Deskripsi</label>
        <textarea id="description" required rows="4" placeholder="Ceritakan tentang anime ini..." style="width: 100%; padding: 0.8rem; border: 2px solid #a855f7; border-radius: 8px;"></textarea>
      </div>

      <div id="uploadProgress" style="display: none; margin-bottom: 1rem;">
        <div style="background: rgba(168, 85, 247, 0.1); border-radius: 8px; overflow: hidden; height: 30px;">
          <div id="progressBar" style="background: linear-gradient(135deg, #a855f7, #c084fc); height: 100%; width: 0%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;"></div>
        </div>
        <p id="progressText" style="text-align: center; margin-top: 0.5rem; color: #666;"></p>
      </div>

      <button type="submit" id="uploadBtn" style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #a855f7, #c084fc); color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer;">
        üöÄ Upload Video
      </button>
    </form>
  </div>

  <script>
    let selectedFile = null;

    function pickFile() {
      // Call Flutter file picker via JavaScript channel
      if (window.FlutterFilePicker) {
        window.FlutterFilePicker.postMessage('pickFile');
      } else {
        alert('‚ùå File picker tidak tersedia. Pastikan menggunakan APK terbaru.');
      }
    }

    // Handle file selected from Flutter
    window.handleFileSelected = function(fileInfo) {
      selectedFile = fileInfo;
      
      // Show file info
      document.getElementById('fileInfo').style.display = 'block';
      document.getElementById('fileName').textContent = 'üìÅ ' + fileInfo.name;
      const sizeMB = (fileInfo.size / (1024 * 1024)).toFixed(2);
      document.getElementById('fileSize').textContent = 'Size: ' + sizeMB + ' MB';
      
      // Show upload form
      document.getElementById('uploadForm').style.display = 'block';
    };

    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      if (!selectedFile) {
        alert('‚ùå Pilih video terlebih dahulu!');
        return;
      }

      // Show progress
      document.getElementById('uploadProgress').style.display = 'block';
      document.getElementById('uploadBtn').disabled = true;
      document.getElementById('uploadBtn').textContent = '‚è≥ Uploading...';

      try {
        // Read file as base64
        const response = await fetch('file://' + selectedFile.path);
        const blob = await response.blob();
        
        const formData = new FormData();
        formData.append('video', blob, selectedFile.name);
        formData.append('title', document.getElementById('title').value);
        formData.append('episode', document.getElementById('episode').value);
        formData.append('category', document.getElementById('category').value);
        formData.append('genre', document.getElementById('genre').value);
        formData.append('description', document.getElementById('description').value);

        const xhr = new XMLHttpRequest();
        
        xhr.upload.addEventListener('progress', function(e) {
          if (e.lengthComputable) {
            const percent = (e.loaded / e.total) * 100;
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressBar').textContent = Math.round(percent) + '%';
            document.getElementById('progressText').textContent = 'Uploading... ' + (e.loaded / (1024 * 1024)).toFixed(2) + ' MB / ' + (e.total / (1024 * 1024)).toFixed(2) + ' MB';
          }
        });

        xhr.addEventListener('load', function() {
          if (xhr.status === 200) {
            alert('‚úÖ Upload berhasil!');
            window.location.href = '/';
          } else {
            alert('‚ùå Upload gagal: ' + xhr.status);
            document.getElementById('uploadBtn').disabled = false;
            document.getElementById('uploadBtn').textContent = 'üöÄ Upload Video';
          }
        });

        xhr.addEventListener('error', function() {
          alert('‚ùå Upload error!');
          document.getElementById('uploadBtn').disabled = false;
          document.getElementById('uploadBtn').textContent = 'üöÄ Upload Video';
        });

        xhr.open('POST', '/upload');
        xhr.send(formData);
      } catch (error) {
        alert('‚ùå Error: ' + error.message);
        document.getElementById('uploadBtn').disabled = false;
        document.getElementById('uploadBtn').textContent = 'üöÄ Upload Video';
      }
    });
  </script>

  <!-- WhatsApp Button -->
  <a href="https://wa.me/6282297706541?text=Hai" target="_blank" style="position: fixed; top: 80px; left: 20px; z-index: 99999; width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, #25D366, #128C7E); color: white; display: flex; align-items: center; justify-content: center; font-size: 26px; text-decoration: none; box-shadow: 0 4px 16px rgba(37, 211, 102, 0.6);">
    üí¨
  </a>
</body>
</html>
