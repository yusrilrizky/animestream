<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload - AnimeStream APK</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <nav class="navbar">
    <div class="container">
      <div class="nav-left">
        <a href="/" class="logo">ğŸ¬ AnimeStream</a>
      </div>
      <div class="nav-right">
        <% if (user) { %>
          <span><%= user.username %></span>
          <a href="/logout">Keluar</a>
        <% } %>
      </div>
    </div>
  </nav>

  <div class="container" style="padding: 2rem;">
    <h2>ğŸ“¤ Upload Anime Baru</h2>
    
    <!-- Upload Method Selector -->
    <div style="display: flex; gap: 1rem; margin-bottom: 2rem; background: rgba(168, 85, 247, 0.1); padding: 0.5rem; border-radius: 12px;">
      <button type="button" onclick="switchMethod('link')" id="linkBtn" style="flex: 1; padding: 1rem; border: 2px solid transparent; background: transparent; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; color: #666;">
        ğŸ”— Upload dengan Link
      </button>
      <button type="button" onclick="switchMethod('file')" id="fileBtn" class="active" style="flex: 1; padding: 1rem; border: 2px solid #a855f7; background: linear-gradient(135deg, #a855f7, #c084fc); border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; color: white;">
        ğŸ“ Upload File
      </button>
    </div>

    <!-- Link Upload Section -->
    <div id="linkSection" style="display: none;">
      <div style="background: rgba(168, 85, 247, 0.1); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
        <h3 style="color: #a855f7; margin-bottom: 1rem;">ğŸ”— Upload dengan Link (Recommended!)</h3>
        <p style="margin-bottom: 1rem;"><strong>Gratis Unlimited!</strong> Upload video ke platform streaming, lalu paste link di sini.</p>
        <p style="font-size: 0.9rem; color: #666;">Platform: Cloudinary, Streamable, Vimeo (AD-FREE), Streamtape, Doodstream, Mixdrop, dll.</p>
      </div>

      <form action="/upload-link" method="POST" id="linkUploadForm">
        <div style="margin-bottom: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">ğŸ”— Link Video</label>
          <input type="url" name="videoLink" required placeholder="https://cloudinary.com/... atau https://streamtape.com/v/xxxxx" style="width: 100%; padding: 0.8rem; border: 2px solid #a855f7; border-radius: 8px;">
        </div>

        <div style="margin-bottom: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">ğŸ¬ Judul Anime</label>
          <input type="text" name="title" required placeholder="Contoh: Naruto Shippuden" style="width: 100%; padding: 0.8rem; border: 2px solid #a855f7; border-radius: 8px;">
        </div>

        <div style="margin-bottom: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">ğŸ“º Episode</label>
          <input type="text" name="episode" required placeholder="Contoh: Episode 1" style="width: 100%; padding: 0.8rem; border: 2px solid #a855f7; border-radius: 8px;">
        </div>

        <div style="margin-bottom: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">ğŸ“‚ Kategori</label>
          <select name="category" style="width: 100%; padding: 0.8rem; border: 2px solid #a855f7; border-radius: 8px;">
            <option value="action">Action</option>
            <option value="adventure">Adventure</option>
            <option value="comedy">Comedy</option>
            <option value="drama">Drama</option>
            <option value="fantasy">Fantasy</option>
            <option value="romance">Romance</option>
            <option value="sci-fi">Sci-Fi</option>
            <option value="slice-of-life">Slice of Life</option>
          </select>
        </div>

        <div style="margin-bottom: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">ğŸ·ï¸ Genre</label>
          <input type="text" name="genre" placeholder="Contoh: Action, Adventure, Shounen" style="width: 100%; padding: 0.8rem; border: 2px solid #a855f7; border-radius: 8px;">
        </div>

        <div style="margin-bottom: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">ğŸ“ Deskripsi</label>
          <textarea name="description" required rows="4" placeholder="Ceritakan tentang anime ini..." style="width: 100%; padding: 0.8rem; border: 2px solid #a855f7; border-radius: 8px;"></textarea>
        </div>

        <button type="submit" style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #a855f7, #c084fc); color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer;">
          ğŸš€ Upload Sekarang
        </button>
      </form>
    </div>

    <!-- File Upload Section -->
    <div id="fileSection">
      <div style="background: rgba(255, 193, 7, 0.1); border: 2px solid #ff9800; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
        <h3 style="color: #ff9800; margin-bottom: 1rem;">âš ï¸ Upload File Tidak Tersedia di APK</h3>
        <p style="margin-bottom: 1rem; color: #666;">Upload file dari galeri tidak bisa digunakan di aplikasi mobile karena keterbatasan WebView.</p>
        <p style="font-weight: 600; color: #ff9800;">Gunakan "Upload dengan Link" untuk upload video!</p>
        <button onclick="switchMethod('link')" style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #a855f7, #c084fc); color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; margin-top: 1rem;">
          ğŸ”— Beralih ke Upload dengan Link
        </button>
      </div>

      <div style="background: rgba(168, 85, 247, 0.05); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; opacity: 0.5;">
        <h3 style="color: #999; margin-bottom: 1rem;">ğŸ“± Upload dari Galeri (Tidak Tersedia)</h3>
        <p style="margin-bottom: 1rem; color: #999;">Fitur ini hanya tersedia di website (browser), tidak di aplikasi mobile.</p>
        
        <button disabled style="width: 100%; padding: 1rem; background: #ccc; color: #666; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: not-allowed;">
          ğŸ“‚ Pilih Video dari Galeri (Disabled)
        </button>
      </div>
    </div>
  </div>

  <script>
    let selectedFile = null;

    function switchMethod(method) {
      const linkBtn = document.getElementById('linkBtn');
      const fileBtn = document.getElementById('fileBtn');
      const linkSection = document.getElementById('linkSection');
      const fileSection = document.getElementById('fileSection');
      
      if (method === 'link') {
        linkBtn.style.background = 'linear-gradient(135deg, #a855f7, #c084fc)';
        linkBtn.style.color = 'white';
        linkBtn.style.border = '2px solid #a855f7';
        fileBtn.style.background = 'transparent';
        fileBtn.style.color = '#666';
        fileBtn.style.border = '2px solid transparent';
        linkSection.style.display = 'block';
        fileSection.style.display = 'none';
      } else {
        fileBtn.style.background = 'linear-gradient(135deg, #a855f7, #c084fc)';
        fileBtn.style.color = 'white';
        fileBtn.style.border = '2px solid #a855f7';
        linkBtn.style.background = 'transparent';
        linkBtn.style.color = '#666';
        linkBtn.style.border = '2px solid transparent';
        fileSection.style.display = 'block';
        linkSection.style.display = 'none';
      }
    }

    function pickFile() {
      // Call Flutter file picker via JavaScript channel
      if (window.FlutterFilePicker) {
        window.FlutterFilePicker.postMessage('pickFile');
      } else {
        alert('âŒ File picker tidak tersedia. Pastikan menggunakan APK terbaru.');
      }
    }

    // Handle file selected from Flutter
    window.handleFileSelected = function(fileInfo) {
      selectedFile = fileInfo;
      console.log('File selected:', fileInfo);
      
      // Show file info
      document.getElementById('fileInfo').style.display = 'block';
      document.getElementById('fileName').textContent = 'ğŸ“ ' + fileInfo.name;
      const sizeMB = (fileInfo.size / (1024 * 1024)).toFixed(2);
      document.getElementById('fileSize').textContent = 'Size: ' + sizeMB + ' MB';
      
      // Enable upload button
      const uploadBtn = document.getElementById('uploadBtn');
      uploadBtn.disabled = false;
      uploadBtn.style.opacity = '1';
      uploadBtn.textContent = 'ğŸš€ Upload Video';
    };

    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      if (!selectedFile) {
        alert('âŒ Pilih video dari galeri terlebih dahulu!');
        return;
      }

      // Validate form
      if (!document.getElementById('title').value || !document.getElementById('episode').value || !document.getElementById('description').value) {
        alert('âŒ Isi semua field yang required!');
        return;
      }

      // Show progress
      document.getElementById('uploadProgress').style.display = 'block';
      document.getElementById('uploadBtn').disabled = true;
      document.getElementById('uploadBtn').textContent = 'â³ Uploading...';

      try {
        // Use Flutter native upload
        const uploadData = {
          filePath: selectedFile.path,
          title: document.getElementById('title').value,
          episode: document.getElementById('episode').value,
          category: document.getElementById('category').value,
          genre: document.getElementById('genre').value,
          description: document.getElementById('description').value
        };
        
        if (window.FlutterFileUpload) {
          window.FlutterFileUpload.postMessage(JSON.stringify(uploadData));
        } else {
          throw new Error('Flutter upload not available');
        }
      } catch (error) {
        alert('âŒ Error: ' + error.message);
        document.getElementById('uploadBtn').disabled = false;
        document.getElementById('uploadBtn').textContent = 'ğŸš€ Upload Video';
        document.getElementById('uploadProgress').style.display = 'none';
      }
    });

    // Handle upload progress from Flutter
    window.handleUploadProgress = function(percent, message) {
      document.getElementById('progressBar').style.width = percent + '%';
      document.getElementById('progressBar').textContent = Math.round(percent) + '%';
      document.getElementById('progressText').textContent = message;
    };

    // Handle upload success
    window.handleUploadSuccess = function() {
      alert('âœ… Upload berhasil!');
      window.location.href = '/';
    };

    // Handle upload error
    window.handleUploadError = function(error) {
      alert('âŒ Upload gagal: ' + error);
      document.getElementById('uploadBtn').disabled = false;
      document.getElementById('uploadBtn').textContent = 'ğŸš€ Upload Video';
      document.getElementById('uploadProgress').style.display = 'none';
    };
  </script>

  <!-- WhatsApp Button -->
  <a href="https://wa.me/6282297706541?text=Hai" target="_blank" style="position: fixed; top: 80px; left: 20px; z-index: 99999; width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, #25D366, #128C7E); color: white; display: flex; align-items: center; justify-content: center; font-size: 26px; text-decoration: none; box-shadow: 0 4px 16px rgba(37, 211, 102, 0.6);">
    ğŸ’¬
  </a>
</body>
</html>
